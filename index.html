<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>haFAnAs - Divisor de Cuentas</title>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- React y Babel -->
    <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <!-- Lucide Icons -->
    <script src="https://unpkg.com/lucide@latest"></script>
    <style>
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        .animate-in { animation: fadeIn 0.3s ease-out forwards; }
        body { -webkit-tap-highlight-color: transparent; }
        .scrollbar-hide::-webkit-scrollbar { display: none; }
    </style>
</head>
<body class="bg-slate-100 overflow-hidden">
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useMemo } = React;
        
        // --- Componentes de Iconos ---
        const Icon = ({ name, className, size = 24 }) => {
            useEffect(() => { if (window.lucide) window.lucide.createIcons(); }, [name]);
            return <i data-lucide={name} className={className} style={{ width: size, height: size }}></i>;
        };

        const Camera = (p) => <Icon name="camera" {...p} />;
        const Plus = (p) => <Icon name="plus" {...p} />;
        const Minus = (p) => <Icon name="minus" {...p} />;
        const Trash2 = (p) => <Icon name="trash-2" {...p} />;
        const Receipt = (p) => <Icon name="receipt" {...p} />;
        const ChevronRight = (p) => <Icon name="chevron-right" {...p} />;
        const ChevronLeft = (p) => <Icon name="chevron-left" {...p} />;
        const Check = (p) => <Icon name="check" {...p} />;
        const Gift = (p) => <Icon name="gift" {...p} />;
        const Loader2 = (p) => <Icon name="loader-2" className={`${p.className} animate-spin`} {...p} />;
        const AlertCircle = (p) => <Icon name="alert-circle" {...p} />;
        const Share2 = (p) => <Icon name="share-2" {...p} />;
        const X = (p) => <Icon name="x" {...p} />;
        const Info = (p) => <Icon name="info" {...p} />;
        const Sparkles = (p) => <Icon name="sparkles" {...p} />;
        const Keyboard = (p) => <Icon name="keyboard" {...p} />;
        const HandCoins = (p) => <Icon name="hand-coins" {...p} />;
        const List = (p) => <Icon name="list" {...p} />;
        const Edit2 = (p) => <Icon name="edit-2" {...p} />;
        const MenuIcon = (p) => <Icon name="menu" {...p} />;

        // --- Constantes ---
        const SAINT_SEIYA = ['Seiya', 'Shiryu', 'Hyoga', 'Shun', 'Ikki', 'Saori', 'Mu', 'Aldebar√°n', 'Saga', 'Kanon', 'M√°scara de Muerte', 'Aioria', 'Shaka', 'Dohko', 'Milo', 'Aioros', 'Shura', 'Camus', 'Afrodita', 'Aries', 'Tauro', 'G√©minis', 'C√°ncer', 'Leo', 'Virgo', 'Libra', 'Escorpio', 'Sagitario', 'Capricornio', 'Acuario', 'Piscis'];
        const NAMES = ['Luna', 'R√≠o', 'Sol', 'Zafiro', 'Jade', 'Rayo', 'Gema', 'Mar', 'Nube', ...SAINT_SEIYA];
        const FACES = ['üòÄ','üòÉ','üòÑ','üòÅ','üòÜ','üòÖ','üòÇ','ü§£','üòä','üòá','üôÇ','üôÉ','üòâ','üòå','üòç','ü•∞','üòò','üòã','üòõ','üòú','ü§™','ü§®','üßê','üòé','ü§©','ü•≥','üòè','ü§î','ü§≠','ü§´','ü§§','üòµ','ü•¥','ü§†'];

        const CATEGORIES = [
            { cat: 'Bebidas', items: [{e:'‚òï',n:'Caf√©'},{e:'üç∫',n:'Cerveza'},{e:'üç∑',n:'Vino'},{e:'ü•§',n:'Refresco'},{e:'üíß',n:'Agua'},{e:'üçπ',n:'C√≥ctel'}] },
            { cat: 'Comidas', items: [{e:'üçï',n:'Pizza'},{e:'üçî',n:'Burger'},{e:'üåÆ',n:'Tacos'},{e:'üç£',n:'Sushi'},{e:'üçù',n:'Pasta'},{e:'ü•ó',n:'Ensalada'},{e:'ü•©',n:'Carne'},{e:'üçó',n:'Pollo'}] },
            { cat: 'Postres', items: [{e:'üç∞',n:'Postre'},{e:'üç¶',n:'Helado'},{e:'üç©',n:'Dona'},{e:'üç™',n:'Galleta'},{e:'ü•û',n:'Panqueques'}] }
        ];

        const PALETTE = [
            { f: 'bg-emerald-500', t: 'text-emerald-700', b: 'border-emerald-200' },
            { f: 'bg-amber-500', t: 'text-amber-700', b: 'border-amber-200' },
            { f: 'bg-rose-500', t: 'text-rose-700', b: 'border-rose-200' },
            { f: 'bg-sky-500', t: 'text-sky-700', b: 'border-sky-200' },
            { f: 'bg-violet-500', t: 'text-violet-700', b: 'border-violet-200' },
            { f: 'bg-orange-500', t: 'text-orange-700', b: 'border-orange-200' },
            { f: 'bg-teal-500', t: 'text-teal-700', b: 'border-teal-200' },
            { f: 'bg-pink-500', t: 'text-pink-700', b: 'border-pink-200' },
            { f: 'bg-indigo-500', t: 'text-indigo-700', b: 'border-indigo-200' },
        ];

        const apiKey = ""; 

        // --- Estructura UI ---
        const UIWrapper = ({ title, children, footer, onBack }) => (
            <div className="flex flex-col h-screen max-w-md mx-auto bg-slate-50 shadow-2xl overflow-hidden font-sans">
                <header className="bg-indigo-600 text-white p-5 shadow-lg relative shrink-0">
                    {onBack && <button onClick={onBack} className="absolute left-4 top-6 p-1.5 bg-white/10 rounded-full active:bg-white/20"><ChevronLeft size={20}/></button>}
                    <div className={onBack ? "ml-8 text-center" : "text-center"}>
                        <h1 className="text-2xl font-black italic tracking-tighter">haFAnAs</h1>
                        <p className="text-indigo-100 text-[10px] font-bold uppercase tracking-widest opacity-80">{title}</p>
                    </div>
                </header>
                <main className="flex-1 overflow-y-auto p-4 space-y-4">{children}</main>
                {footer && <footer className="p-4 bg-white border-t border-slate-200 shrink-0">{footer}</footer>}
            </div>
        );

        const App = () => {
            const [step, setStep] = useState('welcome');
            const [items, setItems] = useState([]);
            const [people, setPeople] = useState([]);
            const [assignments, setAssignments] = useState({});
            const [tax, setTax] = useState(0);
            const [tip, setTip] = useState(10);
            const [pricesIncludeTax, setPricesIncludeTax] = useState(false);
            const [invitations, setInvitations] = useState({});
            const [loading, setLoading] = useState(false);
            const [loadingMessage, setLoadingMessage] = useState("");
            const [error, setError] = useState(null);
            const [selectedPersonDetail, setSelectedPersonDetail] = useState(null);
            const [showFullBreakdown, setShowFullBreakdown] = useState(false);
            const [copySuccess, setCopySuccess] = useState(false);
            const [manualForm, setManualForm] = useState({ name: '', price: '', quantity: '1' });
            const [editingId, setEditingId] = useState(null);
            const [showEmojiMenu, setShowEmojiMenu] = useState(false);

            const generateId = () => Math.random().toString(36).substr(2, 9);
            const getColor = (idx) => PALETTE[idx % PALETTE.length];
            const getFace = () => FACES[Math.floor(Math.random() * FACES.length)];

            const addPerson = (name) => {
                if (!name.trim()) return;
                setPeople([...people, { id: generateId(), name: name.trim(), avatar: getFace() }]);
            };

            const addRandom = () => {
                const val = NAMES[Math.floor(Math.random() * NAMES.length)];
                addPerson(people.some(p => p.name === val) ? `${val} ${people.length + 1}` : val);
            };

            const handleManual = (e) => {
                e.preventDefault();
                if (!manualForm.name || !manualForm.price) return;
                if (editingId) {
                    setItems(items.map(i => i.id === editingId ? { ...i, name: manualForm.name, price: parseFloat(manualForm.price), quantity: parseInt(manualForm.quantity) || 1 } : i));
                    setEditingId(null);
                } else {
                    setItems([...items, { id: generateId(), name: manualForm.name, price: parseFloat(manualForm.price), quantity: parseInt(manualForm.quantity) || 1, ocr: false }]);
                }
                setManualForm({ name: '', price: '', quantity: '1' });
                setShowEmojiMenu(false);
            };

            const processOCR = async (file) => {
                setLoading(true); setLoadingMessage("Leyendo ticket..."); setError(null);
                try {
                    const reader = new FileReader();
                    reader.readAsDataURL(file);
                    reader.onloadend = async () => {
                        const prompt = `Extract items from this receipt as JSON object with "items": [{"name": string, "price": number, "quantity": number}].`;
                        const res = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${apiKey}`, {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({ contents: [{ parts: [{ text: prompt }, { inlineData: { mimeType: "image/png", data: reader.result.split(',')[1] } }] }], generationConfig: { responseMimeType: "application/json" } })
                        });
                        const json = await res.json();
                        const data = JSON.parse(json.candidates[0].content.parts[0].text);
                        setItems(data.items.map(i => ({ ...i, id: generateId(), ocr: true })));
                        setStep('setup');
                    };
                } catch (e) { setError("No se pudo leer el ticket."); } finally { setLoading(false); }
            };

            const calculate = () => {
                const iTotal = items.reduce((acc, i) => acc + i.price, 0);
                const tRate = tax/100, pRate = tip/100;
                let sub, tAm, pAm;
                if (pricesIncludeTax) { sub = iTotal/(1+tRate); tAm = iTotal-sub; pAm = sub*pRate; }
                else { sub = iTotal; tAm = sub*tRate; pAm = sub*pRate; }
                const finalT = iTotal + (pricesIncludeTax ? pAm : (tAm + pAm));

                let pData = {};
                people.forEach(p => pData[p.id] = { name: p.name, base: 0, items: [], inviting: [], paidBy: [] });

                items.forEach(item => {
                    const as = assignments[item.id] || {};
                    const totalW = Object.values(as).reduce((a,b)=>a+b, 0);
                    if (totalW === 0) return;
                    Object.entries(as).forEach(([pId, weight]) => {
                        const share = (weight / totalW) * item.price;
                        const units = (weight / totalW) * item.quantity;
                        pData[pId].base += share;
                        pData[pId].items.push({ name: item.name, share, units, totalQ: item.quantity });
                    });
                });

                people.forEach(p => {
                    const d = pData[p.id];
                    const r = iTotal > 0 ? d.base/iTotal : 0;
                    d.tax = tAm*r; d.tip = pAm*r;
                    d.ownTotal = d.base + (pricesIncludeTax ? d.tip : (d.tax + d.tip));
                });

                let balances = {};
                people.forEach(p => balances[p.id] = pData[p.id].ownTotal);

                people.filter(p => invitations[p.id] === 'everyone').forEach(inv => {
                    const payers = people.filter(p => invitations[p.id] !== 'everyone');
                    const am = balances[inv.id];
                    if (am > 0 && payers.length > 0) {
                        const spl = am/payers.length;
                        payers.forEach(payer => {
                            balances[payer.id] += spl;
                            pData[payer.id].inviting.push({ name: inv.name, amount: spl });
                        });
                        pData[inv.id].paidBy.push({ name: "Grupo", amount: am });
                        balances[inv.id] = 0;
                    }
                });

                Object.entries(invitations).filter(([id, m]) => m !== 'self' && m !== 'everyone').forEach(([tid, hid]) => {
                    const am = balances[tid];
                    if (am > 0) {
                        balances[hid] += am;
                        pData[hid].inviting.push({ name: pData[tid].name, amount: am });
                        pData[tid].paidBy.push({ name: pData[hid].name, amount: am });
                        balances[tid] = 0;
                    }
                });

                people.forEach(p => pData[p.id].final = balances[p.id]);
                return { subtotalNeto: sub, taxAmount: tAm, tipAmount: pAm, total: finalT, pData };
            };

            const results = step === 'results' ? calculate() : null;

            const copy = (text) => {
                const el = document.createElement('textarea'); el.value = text; document.body.appendChild(el); el.select(); document.execCommand('copy'); document.body.removeChild(el);
                setCopySuccess(true); setTimeout(() => setCopySuccess(false), 2000);
            };

            if (step === 'welcome') return (
                <UIWrapper title="Empecemos">
                    <div className="flex flex-col items-center justify-center h-full text-center space-y-8 relative">
                        {loading && <div className="absolute inset-0 bg-white/95 z-50 flex flex-col items-center justify-center p-10"><Loader2 className="text-indigo-600 mb-4" size={48}/><h3 className="text-xl font-bold">{loadingMessage}</h3></div>}
                        <div className="w-24 h-24 bg-indigo-100 rounded-full flex items-center justify-center text-indigo-600 shadow-inner"><Receipt size={48}/></div>
                        <div className="px-6"><h2 className="text-3xl font-black text-slate-800">haFAnAs</h2><p className="text-slate-500 mt-2 text-sm">Cuentas claras, amistades largas.</p></div>
                        <div className="w-full max-w-xs space-y-3">
                            <label className="w-full bg-indigo-600 text-white font-bold py-4 rounded-2xl cursor-pointer flex items-center justify-center gap-2 shadow-lg active:scale-95"><Camera size={20}/> Escanear Ticket<input type="file" accept="image/*" capture="environment" className="hidden" onChange={e => processOCR(e.target.files[0])}/></label>
                            <button onClick={() => setStep('manual_items')} className="w-full bg-white border-2 border-slate-200 text-slate-600 font-bold py-4 rounded-2xl flex items-center justify-center gap-2 active:bg-slate-50 transition-all"><Keyboard size={20}/> Ingreso Manual</button>
                        </div>
                        {error && <div className="text-red-500 text-xs flex items-center gap-1 font-bold animate-pulse"><AlertCircle size={14}/> {error}</div>}
                    </div>
                </UIWrapper>
            );

            if (step === 'manual_items') return (
                <UIWrapper title="Cuenta" onBack={() => setStep('welcome')} footer={<button disabled={items.length === 0} onClick={() => setStep('setup')} className="w-full py-4 bg-indigo-600 text-white font-bold rounded-2xl shadow-lg active:scale-95">Continuar</button>}>
                    <div className="bg-white p-4 rounded-2xl shadow-sm border border-slate-200 space-y-4 animate-in">
                        <form onSubmit={handleManual} className="space-y-3">
                            <div className="relative">
                                <input value={manualForm.name} onChange={e => setManualForm({...manualForm, name: e.target.value})} placeholder="¬øQu√© pidieron?" className="w-full bg-slate-50 border border-slate-200 rounded-xl px-4 py-3 pr-12 outline-none focus:ring-2 focus:ring-indigo-500" required />
                                <button type="button" onClick={() => setShowEmojiMenu(!showEmojiMenu)} className={`absolute right-2 top-1/2 -translate-y-1/2 p-2 rounded-lg ${showEmojiMenu ? 'bg-indigo-600 text-white shadow-md' : 'text-indigo-600 active:bg-indigo-50'}`}><MenuIcon size={20}/></button>
                            </div>
                            {showEmojiMenu && (
                                <div className="bg-slate-100 p-2 rounded-xl border max-h-52 overflow-y-auto grid grid-cols-2 gap-2 shadow-inner">
                                    {CATEGORIES.flatMap(c => c.items).map((i, idx) => (
                                        <button key={idx} type="button" onClick={() => { setManualForm({...manualForm, name: `${i.e} ${i.n}`}); setShowEmojiMenu(false); }} className="p-2.5 bg-white text-[10px] font-black border rounded-xl text-left flex items-center gap-2 active:scale-95"><span>{i.e}</span> {i.n}</button>
                                    ))}
                                </div>
                            )}
                            <div className="flex gap-2">
                                <input value={manualForm.quantity} onChange={e => setManualForm({...manualForm, quantity: e.target.value})} type="number" placeholder="Cant." className="w-20 bg-slate-50 border border-slate-200 rounded-xl px-3 outline-none" required />
                                <input value={manualForm.price} onChange={e => setManualForm({...manualForm, price: e.target.value})} type="number" step="0.01" placeholder="Total $" className="flex-1 bg-slate-50 border border-slate-200 rounded-xl px-4 outline-none" required />
                                <button type="submit" className="bg-indigo-600 text-white p-3 rounded-xl shadow-md">{editingId ? <Check size={20}/> : <Plus size={20}/>}</button>
                            </div>
                        </form>
                    </div>
                    <div className="space-y-2">
                        {items.map(i => (
                            <div key={i.id} className={`flex items-center justify-between bg-white p-4 rounded-xl border animate-in ${editingId === i.id ? 'border-amber-400 bg-amber-50' : 'border-slate-200'}`}>
                                <div className="leading-tight"><div className="font-bold text-slate-700">{i.name}</div><div className="text-[10px] text-slate-400 font-bold uppercase">{i.quantity} und.</div></div>
                                <div className="flex items-center gap-2"><span className="font-black text-indigo-600 mr-2">${i.price.toFixed(2)}</span><button onClick={() => { setEditingId(i.id); setManualForm({name: i.name, price: i.price.toString(), quantity: i.quantity.toString()}); }} className="text-slate-400 p-1 active:text-amber-500"><Edit2 size={16}/></button><button onClick={() => setItems(items.filter(x=>x.id!==i.id))} className="text-red-300 p-1 active:text-red-500"><Trash2 size={16}/></button></div>
                            </div>
                        ))}
                    </div>
                </UIWrapper>
            );

            if (step === 'setup') return (
                <UIWrapper title="Personas" onBack={() => setStep('manual_items')} footer={<button disabled={people.length === 0} onClick={() => setStep('splitting')} className="w-full py-4 bg-indigo-600 text-white font-bold rounded-2xl shadow-lg active:scale-95">Asignar Platos</button>}>
                    <div className="bg-white p-4 rounded-2xl border space-y-3 animate-in shadow-sm">
                        <form onSubmit={e => { e.preventDefault(); addPerson(e.target.personName.value); e.target.reset(); }} className="flex gap-2"><input name="personName" placeholder="Nombre del amigo..." className="flex-1 bg-slate-50 border rounded-xl px-4 outline-none focus:ring-2 focus:ring-indigo-500" /><button type="submit" className="bg-indigo-600 text-white p-3 rounded-xl"><Plus size={20}/></button></form>
                        <button onClick={addRandom} className="w-full py-2 bg-indigo-50 text-indigo-600 rounded-xl text-[10px] font-black flex items-center justify-center gap-2 active:bg-indigo-100 uppercase tracking-widest"><Sparkles size={14}/> Personaje Aleatorio</button>
                    </div>
                    <div className="space-y-2">
                        {people.map((p, idx) => {
                            const c = getColor(idx);
                            return <div key={p.id} className={`flex items-center justify-between bg-white p-3 rounded-xl border ${c.b} animate-in shadow-sm`}><div className="flex items-center gap-3"><div className={`w-10 h-10 ${c.f} rounded-full flex items-center justify-center text-xl shadow-inner`}>{p.avatar}</div><span className="font-bold text-slate-700">{p.name}</span></div><button onClick={() => setPeople(people.filter(x=>x.id!==p.id))} className="text-slate-300 active:text-red-400"><Trash2 size={18}/></button></div>;
                        })}
                    </div>
                </UIWrapper>
            );

            if (step === 'splitting') return (
                <UIWrapper title="Asignaci√≥n" onBack={() => setStep('setup')} footer={<div className="space-y-3"><div className="bg-indigo-50 p-3 rounded-xl space-y-2"><div className="flex items-center justify-between text-[10px] font-black text-indigo-700 uppercase"><span>Impuesto incluido en ticket</span><input type="checkbox" checked={pricesIncludeTax} onChange={e=>setPricesIncludeTax(e.target.checked)} className="w-5 h-5"/></div><div className="flex gap-2"><div className="flex-1"><label className="text-[9px] font-black uppercase text-slate-400">Propina %</label><input type="number" value={tip} onChange={e=>setTip(Number(e.target.value))} className="w-full p-2.5 border rounded-xl outline-none focus:ring-2 focus:ring-indigo-500"/></div><div className="flex-1"><label className="text-[9px] font-black uppercase text-slate-400">Impuesto %</label><input type="number" value={tax} onChange={e=>setTax(Number(e.target.value))} className="w-full p-2.5 border rounded-xl outline-none focus:ring-2 focus:ring-indigo-500"/></div></div></div><button onClick={() => setStep('results')} className="w-full py-4 bg-green-600 text-white font-black rounded-2xl shadow-lg active:scale-95">Ver Resultados Finales</button></div>}>
                    <div className="space-y-4">
                        {items.map(item => {
                            const as = assignments[item.id] || {};
                            const totalW = Object.values(as).reduce((a,b)=>a+b, 0);
                            return (
                                <div key={item.id} className="bg-white rounded-2xl border shadow-sm overflow-hidden animate-in">
                                    <div className="p-3 bg-slate-50 border-b flex justify-between items-center"><div className="font-bold text-slate-700">{item.name}</div><div className="font-black text-indigo-600">${item.price.toFixed(2)}</div></div>
                                    <div className="p-3 space-y-2">
                                        {people.map((p, idx) => {
                                            const w = as[p.id] || 0;
                                            const per = totalW > 0 ? Math.round((w/totalW)*100) : 0;
                                            const c = getColor(idx);
                                            return (
                                                <div key={p.id} className="flex items-center gap-2">
                                                    <button onClick={() => { const curr = assignments[item.id] || {}; if (curr[p.id]) { delete curr[p.id]; setAssignments({...assignments, [item.id]: curr}); } else { setAssignments({...assignments, [item.id]: {...curr, [p.id]: 1}}); } }} className={`relative flex-1 text-left px-3 py-2 rounded-xl text-xs font-bold border transition-all overflow-hidden ${w>0 ? `${c.b} ${c.t}` : 'bg-slate-50 text-slate-300 border-slate-100'}`}>
                                                        {w>0 && <div className={`absolute left-0 top-0 bottom-0 ${c.f} opacity-15 transition-all duration-500`} style={{ width: `${per}%` }}/>}
                                                        <span className="relative z-10 flex items-center gap-1"><span>{p.avatar}</span> {p.name}</span>
                                                    </button>
                                                    {w>0 && <div className="flex items-center gap-1 shrink-0"><span className={`text-[10px] font-black min-w-[30px] ${c.t}`}>{per}%</span><button onClick={()=>setAssignments({...assignments, [item.id]: {...as, [p.id]: Math.max(0.5, (w||0)-0.5)}})} className="bg-slate-100 p-1 rounded-lg active:bg-slate-200"><Minus size={12}/></button><button onClick={()=>setAssignments({...assignments, [item.id]: {...as, [p.id]: (w||0)+0.5}})} className="bg-slate-100 p-1 rounded-lg active:bg-slate-200"><Plus size={12}/></button></div>}
                                                </div>
                                            );
                                        })}
                                    </div>
                                </div>
                            );
                        })}
                    </div>
                </UIWrapper>
            );

            if (step === 'results') return (
                <UIWrapper title="Resumen" onBack={() => setStep('splitting')}>
                    <div className="bg-indigo-900 text-white p-6 rounded-3xl shadow-xl space-y-4 relative overflow-hidden group">
                        <div className="absolute top-0 right-0 p-10 bg-indigo-500 opacity-5 rounded-full scale-150"></div>
                        <div className="flex justify-between items-baseline relative z-10"><span className="uppercase text-[10px] font-black text-indigo-300 tracking-widest">Total Factura</span><span className="text-3xl font-black">${results.total.toFixed(2)}</span></div>
                        <div className="text-xs text-indigo-200 border-t border-indigo-700/50 pt-3 space-y-1 relative z-10">
                            <div className="flex justify-between"><span>Base:</span><span>${results.subtotalNeto.toFixed(2)}</span></div>
                            <div className="flex justify-between"><span>Impuesto ({tax}%):</span><span>${results.taxAmount.toFixed(2)} {pricesIncludeTax && "(Inc.)"}</span></div>
                            <div className="flex justify-between font-black text-white"><span>Propina ({tip}%):</span><span>${results.tipAmount.toFixed(2)}</span></div>
                        </div>
                        <button onClick={()=>setShowFullBreakdown(true)} className="w-full py-2.5 bg-white/10 rounded-xl text-[10px] font-black uppercase tracking-widest border border-white/20 active:bg-white/20 relative z-10">Auditor√≠a de Mesa</button>
                    </div>
                    <div className="bg-white p-4 rounded-2xl border shadow-sm space-y-3">
                        <h3 className="text-[10px] font-black text-slate-400 uppercase tracking-widest flex items-center gap-1"><Gift size={12}/> Gesti√≥n de Invitaciones</h3>
                        {people.map(p => (
                            <div key={p.id} className="flex justify-between items-center text-xs border-b last:border-0 py-2">
                                <span className="font-bold text-slate-600">{p.avatar} {p.name} es pagado por:</span>
                                <select value={invitations[p.id] || 'self'} onChange={e => setInvitations({...invitations, [p.id]: e.target.value})} className="bg-slate-50 font-black text-indigo-600 rounded-lg px-2 py-1 outline-none border border-indigo-50">
                                    <option value="self">S√≠ mismo</option><option value="everyone">Todos</option>
                                    {people.filter(o=>o.id!==p.id).map(o=><option key={o.id} value={o.id}>{o.name}</option>)}
                                </select>
                            </div>
                        ))}
                    </div>
                    <div className="space-y-2 pb-20">
                        {people.map((p, idx) => {
                            const d = results.pData[p.id]; const c = getColor(idx);
                            const isInvited = invitations[p.id] && invitations[p.id] !== 'self';
                            return <button key={p.id} onClick={()=>setSelectedPersonDetail(p)} className={`w-full bg-white p-4 rounded-2xl flex justify-between items-center border transition-all active:scale-98 ${d.final > 0 ? c.b : 'bg-pink-50 border-pink-100 opacity-80'}`}>
                                <div className="text-left flex items-center gap-3"><div className={`w-10 h-10 ${c.f} rounded-full flex items-center justify-center text-xl shadow-sm`}>{p.avatar}</div><div><div className="font-black text-slate-800 text-sm leading-none">{p.name}</div>{isInvited && <div className="text-[8px] font-black text-pink-600 uppercase mt-1 flex items-center gap-0.5"><Gift size={8}/> Invitado</div>}</div></div>
                                <div className="flex items-center gap-3"><span className={`text-xl font-black ${d.final > 0 ? c.t : 'text-slate-300 line-through'}`}>${d.final.toFixed(2)}</span><ChevronRight size={14} className="opacity-20"/></div>
                            </button>;
                        })}
                    </div>

                    {selectedPersonDetail && (
                        <div className="fixed inset-0 bg-slate-900/70 backdrop-blur-sm z-[100] flex items-end sm:items-center justify-center p-4 animate-in">
                            <div className="bg-white w-full max-w-sm rounded-[2.5rem] shadow-2xl overflow-hidden">
                                <div className="p-6 border-b flex justify-between items-center bg-slate-50">
                                    <div className="flex items-center gap-3"><span className="text-3xl">{selectedPersonDetail.avatar}</span><h3 className="font-black text-xl tracking-tight">Cuenta de {selectedPersonDetail.name}</h3></div>
                                    <button onClick={()=>setSelectedPersonDetail(null)} className="p-2 bg-slate-200 rounded-full active:bg-slate-300"><X size={18}/></button>
                                </div>
                                <div className="p-6 space-y-5">
                                    <div className="max-h-64 overflow-y-auto space-y-3 pr-1 scrollbar-hide">
                                        {results.pData[selectedPersonDetail.id].paidBy.length > 0 && <div className="bg-pink-50 p-3 rounded-2xl border border-pink-100">{results.pData[selectedPersonDetail.id].paidBy.map((pb,idx)=><div key={idx} className="text-[10px] font-black text-pink-700 flex justify-between uppercase tracking-wider"><span>Pagado por {pb.name}</span><span>${pb.amount.toFixed(2)}</span></div>)}</div>}
                                        <div className="text-[10px] font-black uppercase text-slate-400 tracking-widest">Consumo Detallado</div>
                                        {results.pData[selectedPersonDetail.id].items.map((i, idx) => <div key={idx} className="flex justify-between text-xs font-bold text-slate-700"><span>{i.name} ({(i.units).toFixed(1)} und.)</span><span>${i.share.toFixed(2)}</span></div>)}
                                        <div className="pt-2 border-t mt-2 space-y-1">
                                            <div className="flex justify-between text-[10px] text-slate-500 font-black uppercase"><span>Propina proporcional:</span><span>${results.pData[selectedPersonDetail.id].tip.toFixed(2)}</span></div>
                                            <div className="flex justify-between text-[10px] text-slate-500 font-black uppercase"><span>Impuesto proporcional:</span><span>{pricesIncludeTax ? <span className="text-indigo-600">Incluido ‚úì</span> : `$${results.pData[selectedPersonDetail.id].tax.toFixed(2)}`}</span></div>
                                        </div>
                                        {results.pData[selectedPersonDetail.id].inviting.map((inv, idx) => <div key={idx} className="flex justify-between text-[10px] font-black text-indigo-600 uppercase border-t border-indigo-50 pt-1"><span>Invitaci√≥n a {inv.name}</span><span>+${inv.amount.toFixed(2)}</span></div>)}
                                    </div>
                                    <div className="pt-4 border-t flex justify-between items-baseline"><span className="text-[11px] font-black uppercase text-slate-400 tracking-widest">Total a Pagar</span><span className="text-4xl font-black text-indigo-600 tracking-tighter">${results.pData[selectedPersonDetail.id].final.toFixed(2)}</span></div>
                                    <button onClick={() => { 
                                        const d = results.pData[selectedPersonDetail.id];
                                        let t = `*haFAnAs - ${selectedPersonDetail.name}*\n\n`;
                                        if (d.paidBy.length > 0) t += `üéÅ *¬°Invitado!* por ${d.paidBy.map(p=>p.name).join(', ')}\n\n`;
                                        t += `üç¥ *Consumo:*\n` + d.items.map(i=>`- ${i.name}: ${i.units.toFixed(1)} und. -> $${i.share.toFixed(2)}`).join('\n') + `\n\n`;
                                        t += `üìä *Extras:*\n- Impuesto: ${pricesIncludeTax ? 'Inc.' : '$'+d.tax.toFixed(2)}\n- Propina: $${d.tip.toFixed(2)}\n`;
                                        if (d.inviting.length > 0) t += `\nüåü *Invitaciones:*\n` + d.inviting.map(i=>`- Por ${i.name}: $${i.amount.toFixed(2)}`).join('\n') + `\n`;
                                        t += `\nüí∞ *TOTAL: $${d.final.toFixed(2)}*`;
                                        copy(t);
                                    }} className={`w-full py-4 rounded-2xl font-black flex items-center justify-center gap-2 transition-all ${copySuccess ? 'bg-green-600 text-white' : 'bg-indigo-600 text-white shadow-xl shadow-indigo-100'}`}>{copySuccess ? <Check size={18}/> : <Share2 size={18}/>} {copySuccess ? 'Copiado' : 'Compartir Resumen'}</button>
                                </div>
                            </div>
                        </div>
                    )}

                    {showFullBreakdown && (
                        <div className="fixed inset-0 bg-slate-900/70 backdrop-blur-sm z-[100] flex items-end sm:items-center justify-center p-4 animate-in">
                            <div className="bg-white w-full max-w-sm rounded-[2.5rem] shadow-2xl flex flex-col max-h-[85vh] overflow-hidden">
                                <div className="p-6 border-b flex justify-between items-center bg-indigo-50 shrink-0"><div className="flex items-center gap-3"><div className="w-10 h-10 bg-indigo-600 text-white rounded-xl flex items-center justify-center"><List size={22}/></div><h3 className="text-xl font-black text-slate-800 tracking-tight">Cuentas de Mesa</h3></div><button onClick={()=>setShowFullBreakdown(false)} className="p-2 bg-white rounded-full border shadow-sm active:bg-slate-50"><X size={18}/></button></div>
                                <div className="flex-1 overflow-y-auto p-4 space-y-4">
                                    {items.map(item => {
                                        const as = assignments[item.id] || {};
                                        const totalW = Object.values(as).reduce((a,b)=>a+b, 0);
                                        return <div key={item.id} className="bg-slate-50 p-4 rounded-2xl border border-slate-200/60 shadow-sm leading-tight">
                                            <div className="flex justify-between font-black text-sm mb-2 text-slate-800"><span>{item.name} ({item.quantity} und.)</span><span className="text-indigo-600">${item.price.toFixed(2)}</span></div>
                                            <div className="space-y-1">{Object.entries(as).map(([pId, w]) => {
                                                const p = people.find(x=>x.id===pId);
                                                return <div key={pId} className="flex justify-between text-[10px] font-bold text-slate-500 tracking-tight"><div className="flex items-center gap-1"><span>{p.avatar}</span><span>{p.name} ({(w/totalW*item.quantity).toFixed(1)} und.)</span></div><span>${(w/totalW*item.price).toFixed(2)}</span></div>;
                                            })}</div>
                                        </div>;
                                    })}
                                    <div className="p-5 bg-indigo-600 text-white rounded-3xl space-y-1.5 shadow-lg">
                                        <div className="flex justify-between text-[10px] font-black uppercase opacity-70"><span>Base Neta:</span><span>${results.subtotalNeto.toFixed(2)}</span></div>
                                        <div className="flex justify-between text-[10px] font-black uppercase opacity-70"><span>Impuesto Global:</span><span>${results.taxAmount.toFixed(2)}</span></div>
                                        <div className="flex justify-between text-[10px] font-black uppercase opacity-70"><span>Propina Global:</span><span>${results.tipAmount.toFixed(2)}</span></div>
                                        <div className="flex justify-between font-black text-xl pt-2 border-t border-white/10 tracking-tighter uppercase"><span>Total Cuenta</span><span>${results.total.toFixed(2)}</span></div>
                                    </div>
                                </div>
                                <div className="p-6 border-t shrink-0"><button onClick={() => {
                                    let t = `*haFAnAs - Auditor√≠a de Mesa* üçΩÔ∏è\n\n`;
                                    items.forEach(i => {
                                        const as = assignments[i.id] || {};
                                        const tw = Object.values(as).reduce((a,b)=>a+b,0);
                                        t += `üìå *${i.name}* ($${i.price.toFixed(2)})\n` + Object.entries(as).map(([pid, w]) => {
                                            const p = people.find(x=>x.id===pid);
                                            return `  ‚Ä¢ ${p.name}: ${(w/tw*i.quantity).toFixed(1)} und. ($${(w/tw*i.price).toFixed(2)})`;
                                        }).join('\n') + '\n\n';
                                    });
                                    t += `üìä *Desglose Final:*\n- Subtotal: $${results.subtotalNeto.toFixed(2)}\n- Impuestos: $${results.taxAmount.toFixed(2)}\n- Propina: $${results.tipAmount.toFixed(2)}\n\nüí∞ *TOTAL MESA: $${results.total.toFixed(2)}*`;
                                    copy(t);
                                }} className={`w-full py-4 rounded-2xl font-black flex items-center justify-center gap-2 active:scale-95 transition-all ${copySuccess ? 'bg-green-600 text-white' : 'bg-slate-800 text-white shadow-lg'}`}>{copySuccess ? <Check size={18}/> : <Share2 size={18}/>} {copySuccess ? 'Copiado' : 'Compartir con el Grupo'}</button></div>
                            </div>
                        </div>
                    )}
                </UIWrapper>
            );
            return null;
        };
        ReactDOM.createRoot(document.getElementById('root')).render(<App />);
    </script>
</body>
</html>